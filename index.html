<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA-CHAT-TRADING | TERMINAL SMC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000000;
            color: #00ff41;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #001100 0%, #003300 50%, #001100 100%);
            border: 2px solid #00ff41;
            border-radius: 10px;
            box-shadow: 0 0 20px #00ff41, inset 0 0 20px rgba(0, 255, 65, 0.1);
            margin-bottom: 20px;
            animation: headerGlow 2s ease-in-out infinite;
        }

        @keyframes headerGlow {
            0%, 100% { box-shadow: 0 0 20px #00ff41, inset 0 0 20px rgba(0, 255, 65, 0.1); }
            50% { box-shadow: 0 0 30px #00ff41, inset 0 0 30px rgba(0, 255, 65, 0.2); }
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41;
            letter-spacing: 5px;
            animation: textFlicker 3s infinite;
        }

        @keyframes textFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .header p {
            margin-top: 10px;
            font-size: 1rem;
            opacity: 0.8;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* TradingView Chart */
        .chart-container {
            background: #000000;
            border: 3px solid #00ff41;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 30px #00ff41;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.3), transparent);
            animation: scanline 3s infinite;
        }

        @keyframes scanline {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .chart-header {
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 0 10px #00ff41;
        }

        #tradingviewChart {
            height: 600px !important;
            display: block !important;
            border: 1px solid #003300;
            border-radius: 5px;
            background: #000000;
        }

        /* Chat Panel */
        .chat-panel {
            background: #000000;
            border: 3px solid #00ff41;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 30px #00ff41;
            display: flex;
            flex-direction: column;
            height: 660px;
        }

        .chat-header {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff41;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ff41;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 51, 0, 0.3);
            border: 1px solid #003300;
            border-radius: 5px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #001100;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid #00ff41;
        }

        .message.ai {
            background: rgba(0, 100, 255, 0.1);
            border-left: 3px solid #0066ff;
            color: #00ccff;
        }

        .message-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            background: #001100;
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        #chatInput:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff41;
        }

        .btn {
            background: linear-gradient(135deg, #003300, #006600);
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .btn:hover {
            background: linear-gradient(135deg, #006600, #009900);
            box-shadow: 0 0 20px #00ff41;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* SMC Modules */
        .smc-modules {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .module {
            background: #000000;
            border: 3px solid #00ff41;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 25px #00ff41;
            position: relative;
            overflow: hidden;
        }

        .module::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff41, transparent);
            animation: lineMove 2s infinite;
        }

        @keyframes lineMove {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .module-header {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff41;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .signal-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            animation: pulseBtn 2s infinite;
        }

        @keyframes pulseBtn {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 65, 0.5); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 65, 0.8); }
        }

        .signal-output {
            background: rgba(0, 51, 0, 0.3);
            border: 1px solid #003300;
            border-radius: 5px;
            padding: 15px;
            min-height: 150px;
            font-size: 0.95rem;
            line-height: 1.8;
        }

        .signal-output .entry {
            color: #ffff00;
            font-weight: bold;
        }

        .signal-output .sl {
            color: #ff0000;
            font-weight: bold;
        }

        .signal-output .tp {
            color: #00ff00;
            font-weight: bold;
        }

        /* Radar de Liquidez */
        .radar-logs {
            background: rgba(0, 51, 0, 0.3);
            border: 1px solid #003300;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .radar-logs::-webkit-scrollbar {
            width: 6px;
        }

        .radar-logs::-webkit-scrollbar-track {
            background: #001100;
        }

        .radar-logs::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 3px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 2px solid #00ff41;
            padding-left: 10px;
            animation: logAppear 0.5s ease-in;
        }

        @keyframes logAppear {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-timestamp {
            color: #666666;
            font-size: 0.75rem;
        }

        .log-type-ob {
            color: #ffaa00;
        }

        .log-type-bos {
            color: #ff00ff;
        }

        .log-type-fvg {
            color: #00ffff;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .smc-modules {
                grid-template-columns: 1fr;
            }
        }

        /* Status Indicator */
        .status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 0.8rem;
            box-shadow: 0 0 15px #00ff41;
            z-index: 1000;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff41;
            margin-right: 8px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        /* API Key Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: #000000;
            border: 3px solid #00ff41;
            border-radius: 10px;
            margin: 15% auto;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 40px #00ff41;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff41;
        }

        .modal-input {
            width: 100%;
            background: #001100;
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .modal-input:focus {
            outline: none;
            box-shadow: 0 0 15px #00ff41;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-info {
            text-align: center;
            font-size: 0.85rem;
            opacity: 0.7;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .config-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 0.8rem;
            box-shadow: 0 0 15px #00ff41;
            z-index: 1000;
            cursor: pointer;
            color: #00ff41;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .config-btn:hover {
            box-shadow: 0 0 25px #00ff41;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- Config Button -->
    <button class="config-btn" onclick="openConfigModal()">‚öôÔ∏è CONFIG API</button>

    <!-- Status Indicator -->
    <div class="status-indicator">
        <span class="status-dot"></span>
        <span>SISTEMA ACTIVO</span>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîë CONFIGURACI√ìN API GEMINI</div>
            <div class="modal-info">
                <strong>‚ö†Ô∏è API Key Requerida</strong><br><br>
                Para usar esta terminal necesitas una API Key de Google Gemini.<br><br>
                <strong>Pasos:</strong><br>
                1. Visita: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41; text-decoration: underline;">Google AI Studio</a><br>
                2. Inicia sesi√≥n con tu cuenta de Google<br>
                3. Haz clic en "Create API Key"<br>
                4. Copia la clave (comienza con "AIza...")<br>
                5. P√©gala abajo y guarda<br><br>
                <small style="opacity: 0.7;">La clave se guarda localmente en tu navegador y nunca se comparte.</small>
            </div>
            <input type="text" id="apiKeyInput" class="modal-input" placeholder="Pega tu API Key aqu√≠ (AIza...)" value="">
            <div class="modal-buttons">
                <button class="btn" onclick="saveApiKey()">GUARDAR Y CONECTAR</button>
                <button class="btn" onclick="closeConfigModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° IA-CHAT-TRADING ‚ö°</h1>
            <p>[ TERMINAL SMC | GOLD TRADING SYSTEM | POWERED BY GEMINI ]</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- TradingView Chart -->
            <div class="chart-container">
                <div class="chart-header">üìà XAUUSD | GOLD LIVE CHART üìà</div>
                <div id="tradingviewChart"></div>
            </div>

            <!-- Chat Panel -->
            <div class="chat-panel">
                <div class="chat-header">ü§ñ GEMINI AI ASSISTANT ü§ñ</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-label">[SISTEMA]</div>
                        <div>Terminal iniciado. Gemini conectado. Listo para analizar XAUUSD.</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" placeholder="Escribe tu consulta..." />
                    <button class="btn" onclick="sendMessage()">ENVIAR</button>
                </div>
            </div>
        </div>

        <!-- SMC Modules -->
        <div class="smc-modules">
            <!-- Signal Generator -->
            <div class="module">
                <div class="module-header">‚ö° GENERADOR DE SE√ëALES ‚ö°</div>
                <button class="btn signal-btn" onclick="generateSignal()">GENERAR SE√ëAL SMC</button>
                <div class="signal-output" id="signalOutput">
                    <div style="text-align: center; opacity: 0.6;">
                        Presiona el bot√≥n para generar una se√±al de trading basada en Smart Money Concepts
                    </div>
                </div>
            </div>

            <!-- Liquidity Radar -->
            <div class="module">
                <div class="module-header">üéØ RADAR DE LIQUIDEZ üéØ</div>
                <div class="radar-logs" id="radarLogs">
                    <div style="text-align: center; opacity: 0.6;">
                        Iniciando escaneo de liquidez...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        // ====================
        // TRADINGVIEW CHART
        // ====================
        function initTradingViewChart() {
            new TradingView.widget({
                "autosize": false,
                "width": "100%",
                "height": 600,
                "symbol": "OANDA:XAUUSD",
                "interval": "15",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "es",
                "toolbar_bg": "#000000",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "container_id": "tradingviewChart",
                "backgroundColor": "#000000",
                "gridColor": "#003300",
                "studies": [
                    "BB@tv-basicstudies"
                ]
            });
        }

        // Inicializar gr√°fico al cargar
        window.addEventListener('load', () => {
            initTradingViewChart();
        });

        // ====================
        // GEMINI AI CHAT
        // ====================
        // Sistema de gesti√≥n de API Key con validaci√≥n autom√°tica
        let CLAVE_DE_API_DE_GEMINI = localStorage.getItem('gemini_api_key') || '';

        // Validaci√≥n de clave al cargar la p√°gina
        function validarClaveAPI() {
            if (!CLAVE_DE_API_DE_GEMINI || CLAVE_DE_API_DE_GEMINI === 'undefined' || CLAVE_DE_API_DE_GEMINI === '') {
                console.warn('‚ö†Ô∏è API Key no configurada. Abriendo modal de configuraci√≥n...');
                setTimeout(() => {
                    openConfigModal();
                    addMessage('ai', '<div class="message-label">[ADVERTENCIA]</div><div>‚ö†Ô∏è No se detect√≥ una API Key v√°lida. Por favor, configura tu clave de Gemini usando el bot√≥n "‚öôÔ∏è CONFIG API".<br><br>Obt√©n tu clave gratis en: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41;">Google AI Studio</a></div>');
                }, 1000);
                return false;
            }
            return true;
        }

        // Funci√≥n para obtener la URL de API din√°mica con validaci√≥n
        function getGeminiApiUrl() {
            if (!CLAVE_DE_API_DE_GEMINI || CLAVE_DE_API_DE_GEMINI === 'undefined' || CLAVE_DE_API_DE_GEMINI === '') {
                throw new Error('API Key no configurada');
            }
            // URL oficial de Google Generative AI API v1beta
            return `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CLAVE_DE_API_DE_GEMINI}`;
        }

        // Modal Management
        function openConfigModal() {
            document.getElementById('apiKeyModal').style.display = 'block';
            document.getElementById('apiKeyInput').value = CLAVE_DE_API_DE_GEMINI;
        }

        function closeConfigModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        function saveApiKey() {
            const newKey = document.getElementById('apiKeyInput').value.trim();
            if (newKey && newKey.startsWith('AIza')) {
                CLAVE_DE_API_DE_GEMINI = newKey;
                localStorage.setItem('gemini_api_key', newKey);
                closeConfigModal();
                addMessage('ai', '<div class="message-label">[SISTEMA]</div><div>‚úÖ API Key actualizada correctamente. La conexi√≥n est√° lista. Intenta enviar un mensaje de prueba.</div>');
            } else {
                alert('‚ö†Ô∏è Por favor ingresa una API Key v√°lida de Google Gemini que comience con "AIza".\n\nObt√©n tu clave en: https://aistudio.google.com/app/apikey');
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('apiKeyModal');
            if (event.target == modal) {
                closeConfigModal();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Validar API Key antes de enviar
            if (!CLAVE_DE_API_DE_GEMINI || CLAVE_DE_API_DE_GEMINI === 'undefined' || CLAVE_DE_API_DE_GEMINI === '') {
                addMessage('ai', '<div class="message-label">[ERROR]</div><div>‚ö†Ô∏è API Key no configurada. Usa el bot√≥n "‚öôÔ∏è CONFIG API" para configurarla.<br><br>Obt√©n tu clave gratis en: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41;">Google AI Studio</a></div>');
                openConfigModal();
                return;
            }

            // Add user message
            addMessage('user', message);
            input.value = '';

            // Add loading message
            const loadingMsg = addMessage('ai', 'Analizando<span class="loading">...</span>');

            try {
                const apiUrl = getGeminiApiUrl();
                console.log('üîå Conectando con Gemini API...');
                console.log('üì° URL:', apiUrl.replace(CLAVE_DE_API_DE_GEMINI, 'AIza***'));
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Eres un experto trader especializado en Smart Money Concepts (SMC) para XAUUSD. ${message}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1000
                        }
                    })
                });

                console.log('üì• Respuesta HTTP:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error de API:', errorText);
                    
                    if (response.status === 404) {
                        loadingMsg.innerHTML = `<div class="message-label">[ERROR 404]</div><div>‚ùå API Key inv√°lida o sin permisos.<br><br>Posibles causas:<br>1. La API Key no existe o fue eliminada<br>2. No tiene permisos para Gemini API<br>3. La API no est√° habilitada en tu proyecto<br><br>Por favor, genera una nueva clave en: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41;">Google AI Studio</a> y config√∫rala con el bot√≥n "‚öôÔ∏è CONFIG API".</div>`;
                        openConfigModal();
                    } else if (response.status === 403) {
                        loadingMsg.innerHTML = `<div class="message-label">[ERROR 403]</div><div>‚ùå Acceso denegado. Verifica que tu API Key tenga permisos para Gemini 1.5 Flash.<br><br>Usa el bot√≥n "‚öôÔ∏è CONFIG API" para configurar una nueva clave.</div>`;
                        openConfigModal();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const data = await response.json();
                console.log('‚úÖ Respuesta exitosa de Gemini');
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    loadingMsg.innerHTML = `<div class="message-label">[GEMINI]</div><div>${aiResponse}</div>`;
                } else if (data.error) {
                    loadingMsg.innerHTML = `<div class="message-label">[ERROR]</div><div>Error de API: ${data.error.message || 'Error desconocido'}<br><br>Usa el bot√≥n "‚öôÔ∏è CONFIG API" para verificar tu clave.</div>`;
                    openConfigModal();
                } else {
                    loadingMsg.innerHTML = `<div class="message-label">[ERROR]</div><div>No se pudo obtener respuesta de Gemini. Verifica tu API Key con el bot√≥n "‚öôÔ∏è CONFIG API".</div>`;
                    openConfigModal();
                }
            } catch (error) {
                console.error('‚ùå Error en sendMessage:', error);
                loadingMsg.innerHTML = `<div class="message-label">[ERROR]</div><div>Error de conexi√≥n: ${error.message}<br><br>Verifica tu API Key con el bot√≥n "‚öôÔ∏è CONFIG API".</div>`;
            }
        }

        function addMessage(type, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            if (type === 'user') {
                messageDiv.innerHTML = `<div class="message-label">[T√ö]</div><div>${content}</div>`;
            } else {
                messageDiv.innerHTML = content;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }

        // Enter key support
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ====================
        // SIGNAL GENERATOR
        // ====================
        async function generateSignal() {
            const output = document.getElementById('signalOutput');
            output.innerHTML = '<div style="text-align: center;">‚ö° GENERANDO SE√ëAL SMC<span class="loading">...</span></div>';

            // Validar API Key antes de generar se√±al
            if (!CLAVE_DE_API_DE_GEMINI || CLAVE_DE_API_DE_GEMINI === 'undefined' || CLAVE_DE_API_DE_GEMINI === '') {
                output.innerHTML = '<div style="color: #ff0000;">‚ö†Ô∏è API Key no configurada. Usa el bot√≥n "‚öôÔ∏è CONFIG API".<br><br><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41;">Obt√©n tu clave aqu√≠</a></div>';
                openConfigModal();
                return;
            }

            try {
                const apiUrl = getGeminiApiUrl();
                console.log('üéØ Generando se√±al SMC...');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Eres un experto en Smart Money Concepts. Genera una se√±al de trading para XAUUSD con los siguientes datos:
- ENTRADA (precio exacto)
- STOP LOSS (precio exacto)
- TAKE PROFIT (precio exacto)
- DIRECCI√ìN (LONG/SHORT)
- RAZ√ìN SMC (Order Block, BOS, Fair Value Gap, etc.)
- RR (Risk:Reward ratio)

Formato: 
SE√ëAL: [LONG/SHORT]
ENTRADA: [precio]
STOP LOSS: [precio]
TAKE PROFIT: [precio]
RAZ√ìN: [explicaci√≥n SMC breve]
RR: [ratio]`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 500
                        }
                    })
                });

                console.log('üì• Respuesta HTTP (Se√±al):', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error de API:', errorText);
                    
                    if (response.status === 404) {
                        output.innerHTML = '<div style="color: #ff0000;">‚ùå ERROR 404: API Key inv√°lida.<br><br>Genera una nueva clave en <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #00ff41;">Google AI Studio</a> y usa el bot√≥n "‚öôÔ∏è CONFIG API".</div>';
                        openConfigModal();
                    } else if (response.status === 403) {
                        output.innerHTML = '<div style="color: #ff0000;">‚ùå ERROR 403: Acceso denegado.<br><br>Verifica los permisos de tu API Key.</div>';
                        openConfigModal();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const data = await response.json();
                console.log('‚úÖ Se√±al generada exitosamente');
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    let signal = data.candidates[0].content.parts[0].text;
                    
                    // Format signal output
                    signal = signal.replace(/ENTRADA:/g, '<span class="entry">ENTRADA:</span>');
                    signal = signal.replace(/STOP LOSS:/g, '<span class="sl">STOP LOSS:</span>');
                    signal = signal.replace(/TAKE PROFIT:/g, '<span class="tp">TAKE PROFIT:</span>');
                    signal = signal.replace(/\n/g, '<br>');
                    
                    output.innerHTML = signal;
                } else if (data.error) {
                    output.innerHTML = `<div style="color: #ff0000;">Error de API: ${data.error.message || 'Error desconocido'}<br><br>Usa "‚öôÔ∏è CONFIG API" para verificar tu clave.</div>`;
                    openConfigModal();
                } else {
                    output.innerHTML = '<div style="color: #ff0000;">Error al generar se√±al. Verifica tu API Key.</div>';
                    openConfigModal();
                }
            } catch (error) {
                console.error('‚ùå Error en generateSignal:', error);
                output.innerHTML = `<div style="color: #ff0000;">Error: ${error.message}<br><br>Usa "‚öôÔ∏è CONFIG API" para configurar tu clave.</div>`;
            }
        }

        // ====================
        // LIQUIDITY RADAR
        // ====================
        const radarPatterns = [
            { type: 'ob', label: 'Order Block detectado', class: 'log-type-ob' },
            { type: 'bos', label: 'Break of Structure', class: 'log-type-bos' },
            { type: 'fvg', label: 'Fair Value Gap identificado', class: 'log-type-fvg' },
            { type: 'ob', label: 'Order Block alcista formado', class: 'log-type-ob' },
            { type: 'bos', label: 'BOS bajista confirmado', class: 'log-type-bos' },
            { type: 'fvg', label: 'FVG en zona de demanda', class: 'log-type-fvg' }
        ];

        function startLiquidityRadar() {
            const logsDiv = document.getElementById('radarLogs');
            logsDiv.innerHTML = '';

            setInterval(() => {
                const pattern = radarPatterns[Math.floor(Math.random() * radarPatterns.length)];
                const price = (2000 + Math.random() * 100).toFixed(2);
                const timestamp = new Date().toLocaleTimeString('es-ES');
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="${pattern.class}"> ‚ñ∂ ${pattern.label}</span>
                    <span style="color: #00ff41;"> @ $${price}</span>
                `;
                
                logsDiv.insertBefore(logEntry, logsDiv.firstChild);
                
                // Keep only last 20 logs
                while (logsDiv.children.length > 20) {
                    logsDiv.removeChild(logsDiv.lastChild);
                }
            }, 3000 + Math.random() * 4000); // Random interval 3-7 seconds
        }

        // Start radar on load
        window.addEventListener('load', () => {
            setTimeout(startLiquidityRadar, 2000);
            // Validar API Key al cargar
            validarClaveAPI();
        });

        // ====================
        // MATRIX RAIN EFFECT (OPTIONAL ENHANCEMENT)
        // ====================
        function createMatrixRain() {
            const canvas = document.createElement('canvas');
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.zIndex = '-1';
            canvas.style.opacity = '0.1';
            document.body.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const chars = '01';
            const fontSize = 14;
            const columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);

            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#00ff41';
                ctx.font = fontSize + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = chars[Math.floor(Math.random() * chars.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            setInterval(draw, 33);
        }

        // Activate Matrix Rain
        window.addEventListener('load', createMatrixRain);
    </script>
</body>
</html>
